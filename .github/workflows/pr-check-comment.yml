name: PR Quality Check Comment

on:
  workflow_run:
    workflows: ['PR Quality Check']
    types: [completed]

permissions:
  contents: read
  issues: write
  pull-requests: read

concurrency:
  group: pr-quality-check-comment-${{ github.event.workflow_run.id }}-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: true

jobs:
  comment:
    runs-on: ubuntu-latest
    # Skip automation PRs to save GitHub Actions minutes
    if: ${{ github.event.workflow_run.event == 'pull_request' && !contains(github.event.workflow_run.head_branch, 'automation/') }}

    steps:
      - name: Post PR status comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTOMATION_PR_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const path = '.github/templates/messages.cjs';
            const workflowRun = context.payload.workflow_run;
            const ref = workflowRun && workflowRun.head_sha ? workflowRun.head_sha : context.sha;

            const { data: file } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path,
              ref
            });

            if (!file || !file.content) {
              throw new Error('Could not load templates from repository content.');
            }

            const content = Buffer.from(file.content, 'base64').toString('utf8');
            const module = { exports: {} };
            const vm = require('vm');
            vm.runInNewContext(content, { module, exports: module.exports, require });
            const templates = module.exports;
            const successT = templates.prCheck.success;
            const failureT = templates.prCheck.failure;

            const headSha = workflowRun.head_sha;
            const conclusion = workflowRun.conclusion;
            let prNumber = null;

            const prs = workflowRun.pull_requests || [];
            if (prs.length > 0 && prs[0].number) {
              prNumber = prs[0].number;
            } else if (headSha) {
              // workflow_run.pull_requests can be empty for some PR workflows; resolve by commit SHA.
              try {
                const { data: associatedPrs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  commit_sha: headSha
                });
                const openPr = (associatedPrs || []).find(function(pr) { return pr.state === 'open'; });
                const fallbackPr = openPr || (associatedPrs || [])[0];
                if (fallbackPr && fallbackPr.number) {
                  prNumber = fallbackPr.number;
                }
              } catch (error) {
                console.log(`Failed to resolve PR by commit SHA ${headSha}: ${error.message}`);
              }
            }

            if (!prNumber) {
              console.log(`No pull request associated with workflow_run ${workflowRun.id} (head_sha=${headSha}); skipping comment.`);
              return;
            }

            const marker = `<!-- pr-quality-check:${headSha} -->`;

            let comments = [];
            let page = 1;
            while (true) {
              const { data: pageItems } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                per_page: 100,
                page: page
              });
              comments = comments.concat(pageItems);
              if (!pageItems || pageItems.length < 100) {
                break;
              }
              page += 1;
            }

            const alreadyCommented = comments.some(function(c) {
              return typeof c.body === 'string' &&
                     c.body.includes(marker);
            });

            if (alreadyCommented) {
              console.log(`Already commented for SHA ${headSha}; skipping`);
              return;
            }

            const isSuccess = conclusion === 'success';
            const t = isSuccess ? successT : failureT;

            const body = `${t.title}\n\n${t.body}\n\n${t.footer}\n\n${marker}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
